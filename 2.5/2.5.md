# Домашнее задание 2.4 «Helm» Голоха Е.В.

## Цель

1. Упаковать приложение в Helm chart для деплоя в разные окружения.
2. Каждый компонент приложения развернуть отдельным `Deployment`.
3. Управлять версией приложения через переменные Helm (image/tag).
4. Развернуть несколько копий приложения:
   - 2 релиза в namespace `app1` (с разными версиями nginx),
   - 1 релиз в namespace `app2`.

---

## 1. Helm chart

Chart: `netology-app`  
Компоненты:
- `nginx` — `Deployment` + `Service (ClusterIP)`
- `multitool` — `Deployment`

Переменные вынесены в `values.yaml` (в т.ч. `nginx.image.tag`, `multitool.image.tag`, `replicaCount`, `pullPolicy`).  
Имена ресурсов формируются через шаблоны Helm (с учётом `.Release.Name`), поэтому два релиза в одном namespace не конфликтуют.

---

## 2. Установка релизов

### Namespace'ы

```bash
kubectl create ns app1
kubectl create ns app2
```

### Установка (фактически применённые версии nginx)

```bash
helm install release-a ./charts/netology-app -n app1 --set nginx.image.tag=1.27.1
helm install release-b ./charts/netology-app -n app1 --set nginx.image.tag=1.27.0
helm install release-c ./charts/netology-app -n app2 --set nginx.image.tag=1.25.4
```

---

## 3. Проверка результатов

### 3.1. Список релизов Helm

Команда:

```bash
helm list -A
```

Вывод:

```text
NAME            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                   APP VERSION
release-a       app1            4               2026-02-28 16:46:13.595548929 +0500 +05 deployed        netology-app-0.1.0      1.0.0
release-b       app1            3               2026-02-28 16:46:14.102785462 +0500 +05 deployed        netology-app-0.1.0      1.0.0
release-c       app2            2               2026-02-28 16:46:14.758570729 +0500 +05 deployed        netology-app-0.1.0      1.0.0
```

---

### 3.2. Состояние ресурсов в `app1`

Команда:

```bash
kubectl get deploy,po,svc -n app1 -o wide
```

Вывод:

```text
NAME                                               READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES                           SELECTOR
deployment.apps/release-a-netology-app-multitool   1/1     1            1           48m   multitool    wbitt/network-multitool:latest   app.kubernetes.io/component=multitool,app.kubernetes.io/instance=release-a,app.kubernetes.io/name=netology-app
deployment.apps/release-a-netology-app-nginx       1/1     1            1           48m   nginx        nginx:1.27.1                     app.kubernetes.io/component=nginx,app.kubernetes.io/instance=release-a,app.kubernetes.io/name=netology-app
deployment.apps/release-b-netology-app-multitool   1/1     1            1           47m   multitool    wbitt/network-multitool:latest   app.kubernetes.io/component=multitool,app.kubernetes.io/instance=release-b,app.kubernetes.io/name=netology-app
deployment.apps/release-b-netology-app-nginx       1/1     1            1           47m   nginx        nginx:1.27.0                     app.kubernetes.io/component=nginx,app.kubernetes.io/instance=release-b,app.kubernetes.io/name=netology-app

NAME                                                    READY   STATUS    RESTARTS   AGE     IP             NODE   NOMINATED NODE   READINESS GATES
pod/release-a-netology-app-multitool-b7c4c79bd-mbsf7    1/1     Running   0          48m     10.1.143.144   zis    <none>           <none>
pod/release-a-netology-app-nginx-5588b8b86f-ncgwb       1/1     Running   0          22m     10.1.143.191   zis    <none>           <none>
pod/release-b-netology-app-multitool-6b6bdb9b5c-k429j   1/1     Running   0          47m     10.1.143.146   zis    <none>           <none>
pod/release-b-netology-app-nginx-7bbf59b9-splxv         1/1     Running   0          7m59s   10.1.143.165   zis    <none>           <none>

NAME                                   TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE   SELECTOR
service/release-a-netology-app-nginx   ClusterIP   10.152.183.243   <none>        80/TCP    48m   app.kubernetes.io/component=nginx,app.kubernetes.io/instance=release-a,app.kubernetes.io/name=netology-app
service/release-b-netology-app-nginx   ClusterIP   10.152.183.218   <none>        80/TCP    47m   app.kubernetes.io/component=nginx,app.kubernetes.io/instance=release-b,app.kubernetes.io/name=netology-app
```

---

### 3.3. Состояние ресурсов в `app2`

Команда:

```bash
kubectl get deploy,po,svc -n app2 -o wide
```

Вывод:

```text
NAME                                               READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES                           SELECTOR
deployment.apps/release-c-netology-app-multitool   1/1     1            1           48m   multitool    wbitt/network-multitool:latest   app.kubernetes.io/component=multitool,app.kubernetes.io/instance=release-c,app.kubernetes.io/name=netology-app
deployment.apps/release-c-netology-app-nginx       1/1     1            1           48m   nginx        nginx:1.25.4                     app.kubernetes.io/component=nginx,app.kubernetes.io/instance=release-c,app.kubernetes.io/name=netology-app

NAME                                                    READY   STATUS    RESTARTS   AGE     IP             NODE   NOMINATED NODE   READINESS GATES
pod/release-c-netology-app-multitool-6c9848c494-9tpg5   1/1     Running   0          48m     10.1.143.141   zis    <none>           <none>
pod/release-c-netology-app-nginx-b9c946664-jfvh5        1/1     Running   0          8m15s   10.1.143.150   zis    <none>           <none>

NAME                                   TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE   SELECTOR
service/release-c-netology-app-nginx   ClusterIP   10.152.183.49   <none>        80/TCP    48m   app.kubernetes.io/component=nginx,app.kubernetes.io/instance=release-c,app.kubernetes.io/name=netology-app
```

---

### 3.4. Проверка связности (curl из multitool в nginx)

Команда:

```bash
kubectl exec -n app1 deploy/release-a-netology-app-multitool -- curl -sS http://release-a-netology-app-nginx | head -n 5
```

Вывод:

```text
<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>
<style>
```

---

### 3.5. Контроль версий nginx (по всем namespace)

Команда:

```bash
kubectl get deploy -A -l app.kubernetes.io/component=nginx -o custom-columns=NS:.metadata.namespace,DEPLOY:.metadata.name,IMAGE:.spec.template.spec.containers[0].image
```

Вывод:

```text
NS    DEPLOY                      IMAGE
app1  release-a-netology-app-nginx nginx:1.27.1
app1  release-b-netology-app-nginx nginx:1.27.0
app2  release-c-netology-app-nginx nginx:1.25.4
```

---

Файлы Helm chart
- charts/netology-app/Chart.yaml
- charts/netology-app/values.yaml
- charts/netology-app/templates/_helpers.tpl
- charts/netology-app/templates/nginx-deployment.yaml
- charts/netology-app/templates/nginx-service.yaml
- charts/netology-app/templates/multitool-deployment.yaml

## Скриншоты

1. `helm list -A`  
   
<img width="1009" height="145" alt="2026-02-28_16-57-14" src="https://github.com/user-attachments/assets/7afbb3ed-b6ae-4326-af83-6d5d7168791d" />

2. `kubectl get deploy,po,svc -n app1 -o wide`  
<img width="1030" height="415" alt="2026-02-28_16-58-05" src="https://github.com/user-attachments/assets/9edb4d22-8cca-48ef-a85f-d8caba31d9be" />

3. `kubectl get deploy,po,svc -n app2 -o wide`  
<img width="1036" height="326" alt="2026-02-28_16-58-44" src="https://github.com/user-attachments/assets/24fb838d-ed4c-4938-bf41-13be22a7766c" />

4. `curl` (проверка связности)  
 <img width="1034" height="242" alt="2026-02-28_16-59-25" src="https://github.com/user-attachments/assets/ff19343e-fcd4-48c3-820d-e0d3284bb5b0" />

5. Матрица версий nginx (`kubectl get deploy -A ... IMAGE`)  
   <img width="1030" height="168" alt="2026-02-28_16-59-59" src="https://github.com/user-attachments/assets/40898078-6a5e-4ac2-a4f6-e3d0334d4426" />
