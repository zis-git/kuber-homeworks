# Домашнее задание: «Компоненты Kubernetes» Голоха Е.В.

## Тема: расчёт требуемых ресурсов кластера под проект

---

## Цель задания
Рассчитать **требуемые вычислительные ресурсы** Kubernetes-кластера для проекта (БД, кеш, бекенд, фронтенд) и описать, какие ресурсы понадобятся для деплоя в разные окружения через Helm chart.

---

## Исходные данные

- **База данных (отказоустойчивая):** 3 копии, 4 ГиБ ОЗУ, 1 CPU на копию.
- **Кеш (отказоустойчивый):** 3 копии, 4 ГиБ ОЗУ, 1 CPU на копию.
- **Фронтенд (статика):** 5 копий, 50 МиБ ОЗУ, 0.2 CPU на копию.
- **Бекенд:** 10 копий, 600 МиБ ОЗУ, 1 CPU на копию.
- Приложение нужно упаковать в **Helm chart** для деплоя в разные окружения.

---

## Допущения (как DevOps при планировании)
1. Значения “потребляет в работе” принимаю как **requests** (гарантируемые ресурсы для планировщика).
2. Для production добавляю **headroom** (запас) на системные поды, пики и переразмещение: **+25%** к суммарной нагрузке.
3. Для отказоустойчивости (3 копии БД и 3 копии кеша) требуется минимум **3 worker-ноды** (размещение реплик по разным нодам), а для устойчивости при отказе 1 ноды — лучше **4 worker-ноды** (N+1).

---

## Расчёт ресурсов (requests)

Формула:

```text
CPU_total  = Σ (replicas × cpu_per_pod)
RAM_total  = Σ (replicas × ram_per_pod)
```

### Таблица расчёта

| Компонент | Реплик | CPU на 1 под | CPU всего | ОЗУ на 1 под | ОЗУ всего |
|---|---:|---:|---:|---:|---:|
| База данных (HA) | 3 | 1.0 | 3.0 | 4 ГиБ | 12 ГиБ |
| Кеш (HA) | 3 | 1.0 | 3.0 | 4 ГиБ | 12 ГиБ |
| Фронтенд | 5 | 0.2 | 1.0 | 50 МиБ | 250 МиБ (~0.24 ГиБ) |
| Бекенд | 10 | 1.0 | 10.0 | 600 МиБ | 6000 МиБ (~5.86 ГиБ) |
| **ИТОГО (requests)** |  |  | **17.0 CPU** |  | **~30.10 ГиБ** |

**Итого по приложению (requests):**
- **CPU:** 17 vCPU  
- **RAM:** ~30.1 ГиБ

---

## Запас (headroom) для production

Расчёт с запасом +25%:

```text
CPU_prod  = 17.0 × 1.25 = 21.25 vCPU
RAM_prod  = 30.10 × 1.25 ≈ 37.63 ГиБ  (≈ 38 ГиБ)
```

**Рекомендуемая ёмкость под нагрузкой (production):**
- **CPU:** ~21.25 vCPU  
- **RAM:** ~38 ГиБ

---

## Рекомендация по worker-нодам (отказоустойчивость)

### Минимально допустимо (чтобы разнести 3 реплики БД и 3 реплики кеша)
- **3 worker-ноды** (anti-affinity / spread по нодам)

Минус: при падении 1 ноды кластер, как правило, не сможет гарантированно удержать все requests.

### Рекомендовано для production (N+1: выдержать отказ 1 ноды)
- **4 worker-ноды по 8 vCPU / 16 ГиБ ОЗУ**

Проверка логики:
- суммарно по 4 нодам ёмкость с запасом достаточна,
- после отказа 1 ноды остаётся ёмкость, чтобы разместить все реплики (включая БД и кеш) и выдержать общий requests-профиль + headroom.

> В реальном проекте дополнительно учитывают `system-reserved`/`kube-reserved`, мониторинг/логи и параметры storage — это может повысить рекомендованный объём RAM на ноду (например, 32 ГиБ вместо 16 ГиБ).

---

## Упаковка в Helm chart (деплой в разные окружения)

Один Helm chart, различия — в `values` для окружений:

- `values-dev.yaml`:
  - уменьшить `replicaCount` (часто 1)
  - меньше `resources.requests/limits`
- `values-stage.yaml`:
  - близко к прод, но возможны меньшие реплики
- `values-prod.yaml`:
  - реплики как в задании (3/3/5/10)
  - включить правила размещения для HA компонентов

Что параметризовать в `values.yaml`:
- `replicaCount` для frontend/backend
- `resources.requests/limits` для каждого компонента
- `affinity` / `podAntiAffinity` / `topologySpreadConstraints` для БД и кеша
- `persistence` (storageClass/размер PVC) для Stateful-сервисов (БД/кеш)

---

## Итог
- Нагрузка приложения (requests): **17 vCPU / ~30.1 ГиБ RAM**
- Рекомендуемая ёмкость для production с запасом +25%: **~21.25 vCPU / ~38 ГиБ RAM**
- Практичная конфигурация worker-части кластера для N+1: **4×(8 vCPU / 16 ГиБ)**

